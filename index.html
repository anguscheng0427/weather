<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Angus Weather | ç”Ÿæ´»æ°£è±¡</title>
    <meta name="description" content="å¤©æ°£ä¸æ˜¯æ•¸æ“šï¼Œè€Œæ˜¯ç”Ÿæ´»ï¼ æˆ‘å€‘æä¾›æœ€ç›´è¦ºçš„ç”Ÿæ´»åŒ–è³‡è¨Šæ‘˜è¦ï¼Œè®“ä½ å‡ºé–€å‰ä¸€ç§’æŒæ¡å¤©æ°£é‡é»ï¼Œè¼•é¬†è¦åŠƒæ¯ä¸€å¤©ï¼">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./assets/weather_icon_512.png">
    <link rel="icon" type="image/x-icon" href="./assets/weather_favicon_48.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', '-apple-system', 'system-ui', 'sans-serif'] },
                    colors: { glass: 'rgba(255, 255, 255, 0.1)' },
                    boxShadow: {
                        'glow': '0 0 10px rgba(255, 255, 255, 0.3)'
                    }
                }
            }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        body {
            background: #0f172a;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .glass-panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.02) 100%);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .skeleton {
            background: rgba(255,255,255,0.1);
            animation: pulse 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 0.8; } 100% { opacity: 0.4; } }

        @keyframes spin-once {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-once {
            animation: spin-once 0.7s ease-in-out;
        }

        /* Toast å‹•ç•« */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</head>
<body class="relative transition-colors duration-700 font-sans" id="body-bg">

    <div class="fixed top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-blue-600 rounded-full mix-blend-screen filter blur-[120px] opacity-20 pointer-events-none animate-pulse"></div>
    <div class="fixed bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-indigo-600 rounded-full mix-blend-screen filter blur-[120px] opacity-20 pointer-events-none"></div>

    <header class="sticky top-0 z-40 w-full transition-all duration-300">
        <div id="nav-backdrop" class="absolute top-0 left-0 w-full h-full bg-[#0f172a]/30 backdrop-blur-xl border-b border-white/5 transition-all duration-300 ease-[cubic-bezier(0.4,0,0.2,1)] shadow-sm origin-top"></div>

        <nav class="relative z-50 flex justify-between items-center px-6 py-4">
            <div class="flex flex-col relative">
                <div class="flex items-center gap-2 cursor-pointer active:scale-95 transition-transform" onclick="toggleQuickBar()">
                    <svg class="w-5 h-5 text-blue-400 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <h1 class="text-xl font-bold tracking-wide drop-shadow-md flex items-center gap-2">
                        <span id="nav-location">è¼‰å…¥ä¸­...</span>
                        <svg id="nav-arrow" class="w-4 h-4 opacity-70 transition-transform duration-300 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </h1>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="toggleFavorites()" class="p-2 rounded-full hover:bg-white/10 transition backdrop-blur-sm" aria-label="åŠ å…¥æœ€æ„›">
                    <svg id="fav-icon" class="w-6 h-6 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                    </svg>
                </button>
                <button onclick="openSearchModal()" class="p-2 rounded-full hover:bg-white/10 transition backdrop-blur-sm" aria-label="æœå°‹">
                    <svg class="w-6 h-6 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
            </div>
        </nav>

        <div id="quick-bar" class="absolute top-[60px] left-0 w-full z-40 transition-all duration-300 transform -translate-y-2 opacity-0 pointer-events-none px-6 pt-4 pb-2">
             <div id="quick-bar-list" class="flex flex-nowrap gap-2 items-center overflow-x-auto no-scrollbar pb-1"></div>
        </div>
    </header>

    <main class="w-full max-w-2xl mx-auto px-4 pb-32 z-10 relative mt-2" id="main-content">
        
        <section class="flex flex-col items-center py-6 relative" onclick="closeQuickBar()">
            <div class="flex items-start justify-center gap-2 mt-2">
                <div class="relative flex items-start" id="current-temp-container">
                    <span class="text-[7rem] leading-none font-thin tracking-tighter drop-shadow-2xl" id="current-temp">--</span>
                    <span class="text-[4rem] leading-none font-light opacity-80 mt-2">Â°</span>
                </div>
                
                <div class="flex flex-col pt-4 gap-1 items-center ml-2">
                    <span class="text-4xl filter drop-shadow-lg min-h-[40px]" id="weather-icon">â³</span>
                    <span class="text-xl font-medium opacity-90 drop-shadow-md min-h-[28px]" id="current-condition">--</span>
                    <span class="text-xs text-blue-200 mt-1 bg-blue-600/40 px-3 py-1 rounded-full border border-blue-400/30 backdrop-blur-sm shadow-sm" id="current-pop-badge">--</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4 mt-2 text-sm font-medium opacity-80 drop-shadow-md">
                <span>æœ€é«˜ <span id="temp-max">--</span>Â°</span>
                <span>æœ€ä½ <span id="temp-min">--</span>Â°</span>
                <span>é«”æ„Ÿ <span id="temp-feel">--</span>Â°</span>
            </div>
        </section>

        <section class="mb-6">
            <div class="glass-panel rounded-3xl p-5 shadow-lg border-t border-white/20">
                <div class="mb-5 pb-4 border-b border-white/10">
                    <h3 class="text-xs font-bold opacity-50 uppercase mb-2 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ç”Ÿæ´»æ°£è±¡æ‘˜è¦
                    </h3>
                    <p id="smart-summary-text" class="text-base font-bold leading-relaxed text-blue-50 transition-opacity opacity-0">
                        æ­£åœ¨åˆ†ææ°£è±¡æ•¸æ“š...
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-2xl bg-white/10 flex items-center justify-center text-3xl shadow-inner flex-shrink-0" id="clothing-icon">
                            ğŸ‘•
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] opacity-50 uppercase">ç©¿è¡£å»ºè­°</span>
                            <span class="text-sm font-bold tracking-wide" id="clothing-text">--</span>
                        </div>
                    </div>

                    <div id="rain-section-container" class="flex justify-left items-center h-[50px]">
                        <div class="w-full h-full flex flex-col justify-center">
                             <div class="w-full h-6 skeleton rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-6">
            <div class="glass-panel rounded-3xl p-5 overflow-hidden">
                <h3 class="text-xs font-bold opacity-50 uppercase mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    24å°æ™‚è¶¨å‹¢
                </h3>
                <div class="overflow-x-auto no-scrollbar relative w-full overflow-y-hidden" id="forecast-scroll-view">
                    <div id="forecast-inner-wrapper" class="relative min-w-full h-64"> 
                        <div class="absolute top-0 left-0 w-full h-[120px] z-0 pointer-events-none" id="chart-layer"></div>
                        <div class="absolute top-[120px] left-0 w-full flex z-10 items-start" id="hourly-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-6">
            <div class="glass-panel rounded-3xl p-5 flex flex-col gap-1">
                <h3 class="text-xs font-bold opacity-50 uppercase mb-2 px-1 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    æœªä¾†é å ±
                </h3>
                <div id="daily-container" class="flex flex-col gap-3">
                    <div class="w-full h-8 skeleton"></div>
                    <div class="w-full h-8 skeleton"></div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="glass-panel rounded-3xl p-5 col-span-1">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xs font-bold opacity-50 uppercase flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"></path></svg>
                        ç©ºæ°£å“è³ª
                    </h3>
                    <span id="aqi-badge" class="text-xs font-bold px-3 py-1 rounded-full bg-gray-600 text-white shadow-sm">--</span>
                </div>
                <div class="flex items-end gap-2 mb-4">
                    <span class="text-4xl font-bold" id="aqi-val">--</span>
                    <span class="text-sm opacity-70 mb-1" id="aqi-status">--</span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div>
                        <div class="flex justify-between text-xs opacity-70 mb-1"><span>PM2.5</span><span id="pm25-val">--</span></div>
                        <div class="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div id="pm25-bar" class="h-full bg-white/50 w-0 transition-all duration-1000"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs opacity-70 mb-1"><span>PM10</span><span id="pm10-val">--</span></div>
                        <div class="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div id="pm10-bar" class="h-full bg-white/50 w-0 transition-all duration-1000"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs opacity-70 mb-1"><span>O3</span><span id="o3-val">--</span></div>
                        <div class="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div id="o3-bar" class="h-full bg-white/50 w-0 transition-all duration-1000"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs opacity-70 mb-1"><span>NO2</span><span id="no2-val">--</span></div>
                        <div class="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div id="no2-bar" class="h-full bg-white/50 w-0 transition-all duration-1000"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                
                <div class="glass-panel rounded-3xl p-4 flex flex-col justify-between h-32">
                    <div class="flex justify-between items-center">
                        <div class="text-xs opacity-60 flex items-center gap-1">
                            <svg class="w-3 h-3 opacity-80" fill="none" viewBox="0 0 20 20" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10 3s-6 7-6 10.5a6 6 0 1012 0C16 10 10 3 10 3z" /></svg> 
                            æ¿•åº¦
                        </div>
                        <span id="humidity-badge" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/20 text-white shadow-sm">--</span>
                    </div>
                    <div class="flex items-end gap-1 mb-1">
                        <span class="text-3xl font-bold" id="humidity-val">--</span>
                        <span class="text-sm opacity-50 mb-1">%</span>
                    </div>
                </div>

                <div class="glass-panel rounded-3xl p-4 flex flex-col justify-between h-32">
                    <div class="flex justify-between items-center">
                        <div class="text-xs opacity-60 flex items-center gap-1">
                            <svg class="w-3.5 h-3.5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            ç´«å¤–ç·š
                        </div>
                        <span id="uv-badge" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/20 text-white shadow-sm">--</span>
                    </div>
                    <div class="flex items-end gap-1 mb-1">
                        <span class="text-3xl font-bold" id="uv-val">--</span>
                        <span class="text-sm opacity-50 mb-1">UVI</span>
                    </div>
                </div>

                <div class="glass-panel rounded-3xl p-4 flex flex-col justify-between h-32">
                    <div class="flex justify-between items-center">
                        <div class="text-xs opacity-60 flex items-center gap-1">
                            <svg class="w-3.5 h-3.5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            èƒ½è¦‹åº¦
                        </div>
                        <span id="vis-badge" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/20 text-white shadow-sm">--</span>
                    </div>
                    <div class="flex items-end gap-1 mb-1">
                        <span class="text-3xl font-bold" id="visibility-val">--</span>
                        <span class="text-sm opacity-50 mb-1">km</span>
                    </div>
                </div>

                <div class="glass-panel rounded-3xl p-4 flex flex-col justify-between h-32">
                    <div class="flex justify-between items-center">
                        <div class="text-xs opacity-60 flex items-center gap-1">
                            <svg class="w-3.5 h-3.5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M12.8 19.6A2 2 0 1 0 14 16H2"/><path d="M17.5 8a2.5 2.5 0 1 1 2 4H2"/><path d="M9.8 4.4A2 2 0 1 1 11 8H2"/></svg>
                            é¢¨é€Ÿ
                        </div>
                        <span id="wind-badge" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/20 text-white shadow-sm">--</span>
                    </div>
                    <div class="flex items-end gap-1 mb-1">
                        <span class="text-3xl font-bold" id="wind-val">--</span>
                        <span class="text-sm opacity-50 mb-1">km/h</span>
                    </div>
                </div>
            </div>
        </section>

        <footer class="text-center opacity-40 text-xs flex flex-col gap-1 pb-4">
            <span>Data by Open-Meteo â€¢ Angus Weather v21.0</span>
            <span id="last-updated">--</span>
        </footer>
    </main>

    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none opacity-0 translate-y-full transition-all duration-300">
        <div class="bg-gray-900/90 backdrop-blur-md text-white px-5 py-2.5 rounded-full shadow-2xl border border-white/10 flex items-center gap-2">
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <span class="text-sm font-bold tracking-wide">å·²æ›´æ–°æœ€æ–°æ°£è±¡</span>
        </div>
    </div>

    <div id="search-modal" class="fixed inset-0 bg-[#0f172a]/95 backdrop-blur-xl z-50 hidden opacity-0 transition-all duration-300 flex flex-col">
        <div class="p-6 pt-12">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">æœå°‹åŸå¸‚</h2>
                <button onclick="closeSearchModal()" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="relative">
                <input type="text" id="search-input" placeholder="ä¾‹å¦‚: å°åŒ—å¸‚, Taipei" 
                    class="w-full bg-white/5 border border-white/10 text-white p-4 pl-12 rounded-2xl outline-none focus:border-blue-500 transition placeholder-gray-500 text-lg">
                <button onclick="performSearch()" class="absolute right-3 top-3 bg-blue-600 px-4 py-1.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-600/30">æœå°‹</button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto px-4 pb-8" id="search-results">
            <div class="text-center opacity-50 mt-10" id="search-placeholder">è«‹è¼¸å…¥é—œéµå­—æœå°‹å…¨çƒåŸå¸‚</div>
        </div>
    </div>

    <script>
        let appState = {
            lat: 25.0330, 
            lon: 121.5654,
            name: "å°åŒ—å¸‚",
            saved: JSON.parse(localStorage.getItem('zenweather_saved')) || []
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderQuickBarList();
            const useAuto = localStorage.getItem('zenweather_use_auto') === 'true';
            
            if (useAuto) {
                useCurrentLocation();
            } else {
                const lastLoc = JSON.parse(localStorage.getItem('zenweather_last_loc'));
                if (lastLoc && lastLoc.name && lastLoc.name !== 'undefined') {
                    changeLocation(lastLoc.lat, lastLoc.lon, lastLoc.name, false);
                } else {
                    useCurrentLocation();
                }
            }
        });

        // --- ä»‹é¢æ§åˆ¶ ---
        function toggleQuickBar() {
            const bar = document.getElementById('quick-bar');
            const bg = document.getElementById('nav-backdrop');
            const arrow = document.getElementById('nav-arrow');
            const isHidden = bar.classList.contains('opacity-0');
            
            if (isHidden) {
                bar.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-2');
                arrow.classList.add('rotate-180');
                bg.style.height = '130px'; 
                bg.classList.remove('border-white/5');
                renderQuickBarList();
            } else {
                closeQuickBar();
            }
        }

        function closeQuickBar() {
            const bar = document.getElementById('quick-bar');
            const bg = document.getElementById('nav-backdrop');
            const arrow = document.getElementById('nav-arrow');
            
            if(!bar.classList.contains('opacity-0')){
                bar.classList.add('opacity-0', 'pointer-events-none', '-translate-y-2');
                arrow.classList.remove('rotate-180');
                bg.style.height = '100%'; 
                setTimeout(() => bg.classList.add('border-white/5'), 200);
            }
        }

        function renderQuickBarList() {
            const list = document.getElementById('quick-bar-list');
            list.innerHTML = '';
            
            const useAuto = localStorage.getItem('zenweather_use_auto') === 'true';
            const activeClass = 'bg-white text-blue-900 font-bold shadow-md';
            const inactiveClass = 'bg-white/10 hover:bg-white/20 text-white backdrop-blur-md border border-white/10';
            
            const gpsBtn = document.createElement('button');
            gpsBtn.className = `flex-shrink-0 px-4 py-2 rounded-full text-sm transition flex items-center gap-1 shadow-sm ${useAuto ? activeClass : inactiveClass}`;
            gpsBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> å®šä½';
            gpsBtn.onclick = () => { useCurrentLocation(); closeQuickBar(); };
            list.appendChild(gpsBtn);

            appState.saved.forEach(p => {
                const isActive = p.name === appState.name && !useAuto; 
                const btnClass = isActive ? activeClass : inactiveClass;
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 px-4 py-2 rounded-full text-sm transition ${btnClass}`;
                btn.innerText = p.name;
                btn.onclick = () => { changeLocation(p.lat, p.lon, p.name, false); closeQuickBar(); };
                list.appendChild(btn);
            });
        }

        function openSearchModal() {
            closeQuickBar();
            const modal = document.getElementById('search-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            document.getElementById('search-input').focus();
        }

        function closeSearchModal() {
            const modal = document.getElementById('search-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('search-results').innerHTML = '<div class="text-center opacity-50 mt-10">è«‹è¼¸å…¥é—œéµå­—æœå°‹å…¨çƒåŸå¸‚</div>';
                document.getElementById('search-input').value = '';
            }, 300);
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0', 'translate-y-full');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-full');
            }, 2500);
        }

        function changeLocation(lat, lon, name, isAuto = false) {
            appState.lat = lat;
            appState.lon = lon;
            appState.name = name || 'æœªçŸ¥åœ°é»';
            
            localStorage.setItem('zenweather_use_auto', isAuto ? 'true' : 'false');
            
            if (!isAuto) {
                localStorage.setItem('zenweather_last_loc', JSON.stringify({ lat, lon, name: appState.name }));
            }

            const displayName = appState.name + (isAuto ? ' (å®šä½)' : '');
            document.getElementById('nav-location').innerText = displayName;
            
            updateFavIcon();
            resetUIForRefresh();
            fetchWeatherData(lat, lon).then(() => showToast());
        }

        function resetUIForRefresh() {
            document.getElementById('current-temp').innerText = "--";
            document.getElementById('current-condition').innerText = "è¼‰å…¥ä¸­...";
            document.getElementById('weather-icon').innerText = "â³";
            document.getElementById('smart-summary-text').innerText = "æ­£åœ¨æ›´æ–°æ•¸æ“š...";
            document.getElementById('smart-summary-text').classList.add('opacity-50');
        }

        // --- å„ªåŒ–ç‰ˆè‡ªå‹•å®šä½ ---
        function useCurrentLocation() {
            closeQuickBar();
            document.getElementById('nav-location').innerText = 'å®šä½ä¸­...';
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async pos => {
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        
                        appState.lat = lat;
                        appState.lon = lon;
                        localStorage.setItem('zenweather_use_auto', 'true');
                        resetUIForRefresh();
                        
                        fetchWeatherData(lat, lon).then(() => showToast());

                        try {
                            const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`);
                            const data = await r.json();
                            const locationName = data.locality || data.city || data.principalSubdivision || "æˆ‘çš„ä½ç½®";
                            
                            appState.name = locationName;
                            document.getElementById('nav-location').innerText = locationName + ' (å®šä½)';
                            updateFavIcon();
                            
                        } catch(e) {
                            console.log("Reverse geo failed", e);
                            document.getElementById('nav-location').innerText = "æˆ‘çš„ä½ç½® (å®šä½)";
                        }
                    },
                    err => { 
                        alert('ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹ç¢ºèªæ¬Šé™');
                        changeLocation(25.0330, 121.5654, "å°åŒ—å¸‚ (é è¨­)", false); 
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                alert('ç€è¦½å™¨ä¸æ”¯æ´å®šä½');
                changeLocation(25.0330, 121.5654, "å°åŒ—å¸‚ (é è¨­)", false);
            }
        }

        async function fetchWeatherData(lat, lon) {
            try {
                // å·²ç¢ºèªç„¡ time åƒæ•¸
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m,wind_direction_10m,surface_pressure,visibility&hourly=temperature_2m,weather_code,precipitation_probability,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max,precipitation_probability_max&timezone=auto&forecast_days=7&past_days=1`;
                const airUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi,pm10,pm2_5,nitrogen_dioxide,ozone&timezone=auto`;

                const [resW, resA] = await Promise.all([ fetch(weatherUrl), fetch(airUrl).catch(() => null) ]);
                if (!resW.ok) throw new Error('Weather API Error');
                const dataW = await resW.json();
                let dataA = { current: {} };
                if (resA && resA.ok) dataA = await resA.json();

                updateUI(dataW, dataA);
                
                const localTimeStr = dataW.current.time; 
                if(localTimeStr) {
                    const timePart = localTimeStr.split('T')[1];
                    document.getElementById('last-updated').innerText = `ç•¶åœ°æ™‚é–“ ${timePart}`;
                } else {
                    const now = new Date();
                    document.getElementById('last-updated').innerText = `æ›´æ–°æ–¼ ${now.toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit', hour12: false})}`;
                }
            } catch (err) {
                console.error("Fetch Error:", err);
                document.getElementById('current-condition').innerText = "é€£ç·šå¤±æ•—";
            }
        }

        function updateUI(wData, aData) {
            const current = wData.current;
            const hourly = wData.hourly;
            const daily = wData.daily;
            const air = aData.current || {};

            if (!current || !hourly) return;

            const currentLocalTimeIso = current.time; 
            let nowIdx = 0;
            if(currentLocalTimeIso) {
                const currentHourKey = currentLocalTimeIso.substring(0, 13);
                nowIdx = hourly.time.findIndex(t => t.startsWith(currentHourKey));
                if (nowIdx === -1) nowIdx = 0;
            }

            updateLifeDashboard(current, hourly, daily, nowIdx);

            document.getElementById('current-temp').innerText = Math.round(current.temperature_2m);
            const wInfo = getWeatherCodeInfo(current.weather_code, current.is_day);
            document.getElementById('current-condition').innerText = wInfo.desc;
            document.getElementById('weather-icon').innerText = wInfo.icon;
            
            const currentPop = (nowIdx !== -1 && hourly.precipitation_probability[nowIdx] !== undefined) ? hourly.precipitation_probability[nowIdx] : 0;
            document.getElementById('current-pop-badge').innerText = `é™é›¨æ©Ÿç‡ ${currentPop}%`;

            if (daily && daily.temperature_2m_max && daily.temperature_2m_max.length > 1) {
                document.getElementById('temp-max').innerText = Math.round(daily.temperature_2m_max[1]);
                document.getElementById('temp-min').innerText = Math.round(daily.temperature_2m_min[1]);
            } else {
                document.getElementById('temp-max').innerText = "--";
                document.getElementById('temp-min').innerText = "--";
            }
            document.getElementById('temp-feel').innerText = Math.round(current.apparent_temperature);

            updateBackground(current.weather_code, current.is_day);
            renderSyncChart(hourly, nowIdx);

            // --- AQI æ›´æ–° (æ·¡åŒ–è‰²æ¢) ---
            const aqi = air.us_aqi ?? '--';
            document.getElementById('aqi-val').innerText = aqi;
            
            const aqiInfo = getAQIStatus(aqi);
            const badge = document.getElementById('aqi-badge');
            badge.innerText = aqiInfo.text;
            badge.className = `text-xs font-bold px-3 py-1 rounded-full text-white shadow-sm ${aqiInfo.color}`;
            document.getElementById('aqi-status').innerText = aqiInfo.desc;

            const pm25 = air.pm2_5 ?? 0;
            const pm10 = air.pm10 ?? 0;
            const o3 = air.ozone ?? 0;
            const no2 = air.nitrogen_dioxide ?? 0;

            document.getElementById('pm25-val').innerText = pm25;
            document.getElementById('pm10-val').innerText = pm10;
            document.getElementById('o3-val').innerText = o3;
            document.getElementById('no2-val').innerText = no2;

            setTimeout(() => {
                document.getElementById('pm25-bar').style.width = Math.min((pm25 / 75) * 100, 100) + '%';
                document.getElementById('pm10-bar').style.width = Math.min((pm10 / 150) * 100, 100) + '%';
                document.getElementById('o3-bar').style.width = Math.min((o3 / 180) * 100, 100) + '%';
                document.getElementById('no2-bar').style.width = Math.min((no2 / 100) * 100, 100) + '%';
            }, 100);

            // --- ç”Ÿæ´»æ•¸æ“š (æ–°ç‰ˆè† å›Šæ¨™ç¤º) ---
            const humidity = current.relative_humidity_2m;
            const hStatus = getHumidityStatus(humidity);
            document.getElementById('humidity-val').innerText = humidity;
            const hBadge = document.getElementById('humidity-badge');
            hBadge.innerText = hStatus.text;
            hBadge.className = `text-[10px] font-bold px-2 py-0.5 rounded-full text-white shadow-sm ${hStatus.color}`;

            const uv = (daily.uv_index_max && daily.uv_index_max.length > 1) ? daily.uv_index_max[1] : 0;
            const uvStatus = getUVStatus(uv);
            document.getElementById('uv-val').innerText = uv;
            const uvBadge = document.getElementById('uv-badge');
            uvBadge.innerText = uvStatus.text;
            uvBadge.className = `text-[10px] font-bold px-2 py-0.5 rounded-full text-white shadow-sm ${uvStatus.color}`;
            
            const visKm = current.visibility !== undefined ? (current.visibility / 1000).toFixed(1) : '--';
            const visStatus = getVisibilityStatus(current.visibility);
            document.getElementById('visibility-val').innerText = visKm;
            const visBadge = document.getElementById('vis-badge');
            visBadge.innerText = visStatus.text;
            visBadge.className = `text-[10px] font-bold px-2 py-0.5 rounded-full text-white shadow-sm ${visStatus.color}`;
            
            const wind = current.wind_speed_10m;
            const windStatus = getWindStatus(wind);
            document.getElementById('wind-val').innerText = wind;
            const windBadge = document.getElementById('wind-badge');
            windBadge.innerText = windStatus.text;
            windBadge.className = `text-[10px] font-bold px-2 py-0.5 rounded-full text-white shadow-sm ${windStatus.color}`;

            renderDailyForecast(daily);
        }

        // --- ç‹€æ…‹åˆ¤æ–· (å¸¸æ…‹ç‚ºæ·¡è‰²) ---
        function getAQIStatus(aqi) {
            if(aqi == '--') return { text: 'æœªçŸ¥', color: 'bg-gray-500', desc: '-' };
            if(aqi <= 50) return { text: 'è‰¯å¥½', color: 'bg-green-500', desc: 'ç©ºæ°£æ¸…æ–°' };
            if(aqi <= 100) return { text: 'æ™®é€š', color: 'bg-yellow-500', desc: 'å°šå¯æ¥å—' };
            if(aqi <= 150) return { text: 'ä¸å¥åº·', color: 'bg-orange-500', desc: 'æ•æ„Ÿæ—ç¾¤æ³¨æ„' };
            return { text: 'å±éšª', color: 'bg-red-600', desc: 'å»ºè­°æˆ´å£ç½©' };
        }

        function getHumidityStatus(val) {
            if(val < 40) return { text: 'ä¹¾ç‡¥', color: 'bg-yellow-500' };
            if(val <= 70) return { text: 'èˆ’é©', color: 'bg-white/20' }; // æ·¡åŒ–
            return { text: 'æ½®æ¿•', color: 'bg-blue-500' };
        }

        function getUVStatus(val) {
            if(val <= 2) return { text: 'ä½é‡', color: 'bg-white/20' }; // æ·¡åŒ–
            if(val <= 5) return { text: 'ä¸­é‡', color: 'bg-yellow-500' };
            if(val <= 7) return { text: 'é«˜é‡', color: 'bg-orange-500' };
            if(val <= 10) return { text: 'éé‡', color: 'bg-red-500' };
            return { text: 'å±éšª', color: 'bg-purple-600' };
        }

        function getVisibilityStatus(meters) {
            if(meters === undefined) return { text: '--', color: 'bg-gray-500' };
            if(meters >= 10000) return { text: 'æ¥µä½³', color: 'bg-white/20' }; // æ·¡åŒ–
            if(meters >= 5000) return { text: 'è‰¯å¥½', color: 'bg-blue-400' };
            if(meters >= 1000) return { text: 'æ™®é€š', color: 'bg-yellow-500' };
            return { text: 'éœ§éœ¾', color: 'bg-red-500' };
        }

        function getWindStatus(speed) {
            if(speed == undefined) return { text: '--', color: 'bg-gray-500' };
            if(speed < 5) return { text: 'ç„¡é¢¨', color: 'bg-white/20' }; // æ·¡åŒ–
            if(speed < 12) return { text: 'å¾®é¢¨', color: 'bg-white/20' }; // æ·¡åŒ–
            if(speed < 29) return { text: 'å’Œé¢¨', color: 'bg-blue-400' };
            if(speed < 50) return { text: 'å¼·é¢¨', color: 'bg-yellow-500' };
            return { text: 'çƒˆé¢¨', color: 'bg-red-600' };
        }

        function updateLifeDashboard(current, hourly, daily, nowIdx) {
            const summaryEl = document.getElementById('smart-summary-text');
            summaryEl.classList.remove('opacity-50');

            if(!daily.temperature_2m_max || daily.temperature_2m_max.length < 3) {
                 summaryEl.innerText = "è³‡æ–™ä¸è¶³...";
                 return;
            }

            const yesterdayMax = Math.round(daily.temperature_2m_max[0]);
            const todayMax = Math.round(daily.temperature_2m_max[1]);
            const tomorrowMax = Math.round(daily.temperature_2m_max[2]);
            const currentTemp = current.temperature_2m;
            let localHour = new Date().getHours();
            if(current.time) {
                localHour = parseInt(current.time.split('T')[1].split(':')[0]);
            }

            let text = "";
            let diff = 0;

            if (localHour < 18) {
                diff = todayMax - yesterdayMax;
                if (diff > 1) text = (currentTemp < 20) ? `æ°£æº«ç•¥å›å‡ (+${diff}Â°C)ï¼Œä»åæ¶¼` : `ä»Šå¤©æ¯”æ˜¨å¤©ç†± ${diff}Â°C`;
                else if (diff < -1) text = `ä»Šå¤©æ¯”æ˜¨å¤©å†· ${Math.abs(diff)}Â°C`;
                else text = `æ°£æº«èˆ‡æ˜¨å¤©å·®ä¸å¤š`;
            } else {
                diff = tomorrowMax - todayMax;
                if (diff > 1) text = (currentTemp < 20) ? `æ˜å¤©æ°£æº«å›å‡ (+${diff}Â°C)` : `æ˜å¤©æ¯”ä»Šå¤©ç†± ${diff}Â°C`;
                else if (diff < -1) text = `æ˜å¤©æ¯”ä»Šå¤©å†· ${Math.abs(diff)}Â°C`;
                else text = `æ˜å¤©æ°£æº«æŒå¹³`;
            }

            const code = current.weather_code;
            if (code >= 95) text = "â›ˆï¸ é›·é›¨è­¦å ±ï¼" + text;
            else if (code >= 61) text = "ğŸŒ§ï¸ å¤–é¢æœ‰é›¨ï¼Œ" + text;
            else if (currentTemp < 15) text += "ï¼Œæ³¨æ„ä¿æš– ğŸ§¥";
            else if (currentTemp > 30) text += "ï¼Œæ³¨æ„é˜²æ›¬ ğŸ§´";
            else text += "ï¼Œèˆ’é©å®œäºº âœ¨";

            summaryEl.innerText = text;
            summaryEl.classList.remove('opacity-0');

            const feel = current.apparent_temperature;
            const clothIconEl = document.getElementById('clothing-icon');
            const clothTextEl = document.getElementById('clothing-text');
            
            let cIcon="ğŸ‘•", cText="èˆ’é©";
            if (feel > 28) { cIcon="ğŸ½"; cText="çŸ­è¢–/é€æ°£"; }
            else if (feel >= 24) { cIcon="ğŸ‘•"; cText="çŸ­è¢–"; }
            else if (feel >= 20) { cIcon="ğŸ‘”"; cText="è–„é•·è¢–"; }
            else if (feel >= 15) { cIcon="ğŸ§¥"; cText="å¤¾å…‹/å¸½T"; }
            else if (feel >= 10) { cIcon="ğŸ§£"; cText="åšå¤–å¥—"; }
            else { cIcon="ğŸ§¤"; cText="ç¾½çµ¨/ç™¼ç†±è¡£"; }
            
            clothIconEl.innerText = cIcon;
            clothTextEl.innerText = cText;

            const rainContainer = document.getElementById('rain-section-container');
            let hasRain = false;
            let firstRain = -1;

            for(let i=0; i<12; i++) {
                let idx = nowIdx + i;
                if(idx >= hourly.precipitation_probability.length) break;
                const pop = hourly.precipitation_probability[idx];
                if(pop >= 30) {
                    hasRain = true;
                    if(firstRain === -1) firstRain = i;
                }
            }

            if (!hasRain) {
                rainContainer.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-2xl bg-white/10 flex items-center justify-center text-3xl shadow-inner flex-shrink-0 text-blue-200">
                            ğŸŒ‚
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] opacity-50 uppercase">é™é›¨æ©Ÿç‡</span>
                            <span class="text-sm font-bold tracking-wide text-blue-200">æœªä¾† 12h ç„¡é›¨</span>
                        </div>
                    </div>
                `;
            } else {
                let statusText = firstRain === 0 ? "ç›®å‰æœ‰é›¨" : `${firstRain}h å¾Œæœ‰é›¨`;
                let barsHtml = '';
                
                for(let i=0; i<12; i++) {
                    let idx = nowIdx + i;
                    let isRain = false;
                    if(idx < hourly.precipitation_probability.length) {
                        isRain = hourly.precipitation_probability[idx] >= 30;
                    }
                    barsHtml += `<div class="flex-1 h-full border-r border-black/10 last:border-0 ${isRain ? 'bg-blue-500' : 'bg-white/5'}"></div>`;
                }

                rainContainer.innerHTML = `
                    <div class="flex flex-col justify-center w-full">
                        <div class="flex justify-between items-end mb-1.5">
                            <span class="text-[10px] opacity-50 uppercase">æœªä¾† 12 å°æ™‚é™é›¨</span>
                            <span class="text-[10px] font-bold text-blue-300">${statusText}</span>
                        </div>
                        <div class="w-full h-2.5 bg-black/20 rounded-full flex overflow-hidden border border-white/5">
                            ${barsHtml}
                        </div>
                    </div>
                `;
            }
        }

        function renderSyncChart(hourly, startIdx) {
            const chartLayer = document.getElementById('chart-layer');
            const listLayer = document.getElementById('hourly-list');
            const wrapper = document.getElementById('forecast-inner-wrapper');
            
            chartLayer.innerHTML = '';
            listLayer.innerHTML = '';

            if (startIdx === undefined || startIdx === -1) startIdx = 0;

            const hoursCount = 24;
            const ITEM_WIDTH = 55;
            const TOTAL_WIDTH = hoursCount * ITEM_WIDTH;
            
            wrapper.style.width = `${TOTAL_WIDTH}px`;

            const temps = [];
            const points = [];

            for (let i = 0; i < hoursCount; i++) {
                let idx = startIdx + i;
                if (idx >= hourly.time.length) break;
                
                const temp = Math.round(hourly.temperature_2m[idx]);
                temps.push(temp);
                
                const t = hourly.time[idx]; 
                const hourPart = t.split('T')[1].split(':')[0];
                const hourNum = parseInt(hourPart, 10);
                
                let timeStr = i === 0 ? 'ç¾åœ¨' : (hourNum % 12 || 12) + (hourNum >= 12 ? 'PM' : 'AM');
                
                const wCode = hourly.weather_code[idx];
                const isD = hourly.is_day[idx];
                const wInfo = getWeatherCodeInfo(wCode, isD);
                const pop = hourly.precipitation_probability[idx] ?? 0;

                const item = document.createElement('div');
                item.style.width = `${ITEM_WIDTH}px`;
                item.className = 'flex flex-col items-center flex-shrink-0 relative h-32 justify-start pt-2'; 
                
                item.innerHTML = `
                    <div class="text-center w-full">
                        <span class="text-[10px] opacity-50 block mb-1">${timeStr}</span>
                        <span class="text-lg block mb-1">${wInfo.icon}</span>
                    </div>
                    <div class="flex flex-col items-center justify-end h-16 w-1.5 bg-white/5 rounded-full overflow-hidden mt-1">
                         <div class="w-full bg-blue-500 rounded-t-sm transition-all duration-500" style="height: ${pop}%;"></div>
                    </div>
                    <span class="text-[9px] mt-1 opacity-60">${pop}%</span>
                `;
                listLayer.appendChild(item);
            }

            if(temps.length === 0) return;

            const maxT = Math.max(...temps);
            const minT = Math.min(...temps);
            const range = (maxT - minT) || 1;
            const paddingTop = 30;
            const paddingBottom = 10;
            const drawingHeight = 120 - paddingTop - paddingBottom;

            temps.forEach((t, i) => {
                const x = (i * ITEM_WIDTH) + (ITEM_WIDTH / 2);
                const normalizedT = (t - minT) / range; 
                const y = (120 - paddingBottom) - (normalizedT * drawingHeight);
                points.push({x, y, t});
            });

            const polylinePoints = points.map(p => `${p.x},${p.y}`).join(' ');
            
            const areaPath = `M${ITEM_WIDTH/2},120 L${points[0].x},${points[0].y} ` + 
                             points.map((p,i) => i===0?'':`L${p.x},${p.y}`).join(' ') + 
                             ` L${points[points.length-1].x},120 Z`;

            const textElements = points.map(p => 
                `<text x="${p.x}" y="${p.y - 12}" text-anchor="middle" fill="white" font-size="12" font-weight="bold" style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${p.t}Â°</text>`
            ).join('');

            const dots = points.map(p => 
                `<circle cx="${p.x}" cy="${p.y}" r="3" fill="white" stroke="rgba(255,255,255,0.2)" stroke-width="4" />`
            ).join('');

            chartLayer.innerHTML = `
                <svg width="${TOTAL_WIDTH}" height="120" viewBox="0 0 ${TOTAL_WIDTH} 120" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="chartGrad" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stop-color="white" stop-opacity="0.2"/>
                            <stop offset="100%" stop-color="white" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <path d="${areaPath}" fill="url(#chartGrad)" />
                    <polyline points="${polylinePoints}" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    ${dots}
                    ${textElements}
                </svg>
            `;
        }

        function renderDailyForecast(daily) {
            const container = document.getElementById('daily-container');
            container.innerHTML = '';
            const count = Math.min(daily.time.length, 8); 

            for(let i = 0; i < count; i++) {
                const dateStr = daily.time[i];
                const dateObj = new Date(dateStr);
                
                let dayName = "";
                if (i === 0) dayName = "æ˜¨å¤©";
                else if (i === 1) dayName = "ä»Šå¤©";
                else dayName = dateObj.toLocaleDateString('zh-TW', {weekday: 'long'});

                const max = Math.round(daily.temperature_2m_max[i]);
                const min = Math.round(daily.temperature_2m_min[i]);
                const wInfo = getWeatherCodeInfo(daily.weather_code[i], 1); 
                const rainProb = daily.precipitation_probability_max[i] ?? 0;
                
                const rainBadge = rainProb >= 30 
                    ? `<div class="flex items-center gap-1 text-blue-200 bg-blue-600/30 border border-blue-400/20 px-2 py-0.5 rounded-md text-xs font-bold">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z"/><path d="M9 13h2v5a1 1 0 11-2 0v-5z"/></svg>
                        ${rainProb}%
                       </div>`
                    : `<span class="text-xs opacity-30">${rainProb}%</span>`;

                // æœªä¾†é å ±è¡¨æ ¼å„ªåŒ– (Highlight ä»Šå¤©)
                const isToday = (i === 1);
                const bgClass = isToday ? 'bg-white/10 rounded-xl' : '';
                // ç§»é™¤ hover:bg-white/5ï¼Œæ¸›å°‘é–“è· py-3 -> py-2
                const row = document.createElement('div');
                row.className = `flex justify-between items-center py-2 px-2 transition ${bgClass} ${i===0?'opacity-50':''}`;
                
                row.innerHTML = `
                    <span class="w-16 font-medium text-sm">${dayName}</span>
                    <div class="flex items-center gap-3 flex-1 justify-start pl-2">
                        <span class="text-xl w-8 text-center">${wInfo.icon}</span>
                        ${rainBadge}
                    </div>
                    <div class="flex gap-4 text-sm">
                        <span class="font-bold w-6 text-right">${max}Â°</span>
                        <span class="opacity-50 w-6 text-right">${min}Â°</span>
                    </div>
                `;
                container.appendChild(row);
            }
        }

        function getWeatherCodeInfo(code, isDay) {
            if (code === undefined || code === null) return { desc: 'è¼‰å…¥ä¸­', icon: 'â³' };
            const map = {
                0: { d: 'æ™´æœ—', n: 'æ™´æœ—', di: 'â˜€ï¸', ni: 'ğŸŒ™' },
                1: { d: 'å¤šé›²æ™‚æ™´', n: 'å¤šé›²æ™‚æ™´', di: 'ğŸŒ¤ï¸', ni: 'ğŸŒ™' },
                2: { d: 'å¤šé›²', n: 'å¤šé›²', di: 'â›…', ni: 'â˜ï¸' },
                3: { d: 'é™°å¤©', n: 'é™°å¤©', di: 'â˜ï¸', ni: 'â˜ï¸' },
                45: { d: 'éœ§', n: 'éœ§', di: 'ğŸŒ«ï¸', ni: 'ğŸŒ«ï¸' },
                48: { d: 'éœ§', n: 'éœ§', di: 'ğŸŒ«ï¸', ni: 'ğŸŒ«ï¸' },
                51: { d: 'æ¯›æ¯›é›¨', n: 'æ¯›æ¯›é›¨', di: 'ğŸŒ¦ï¸', ni: 'ğŸŒ§ï¸' },
                53: { d: 'å°é›¨', n: 'å°é›¨', di: 'ğŸŒ¦ï¸', ni: 'ğŸŒ§ï¸' },
                55: { d: 'é™£é›¨', n: 'é™£é›¨', di: 'ğŸŒ§ï¸', ni: 'ğŸŒ§ï¸' },
                56: { d: 'å‡é›¨', n: 'å‡é›¨', di: 'ğŸŒ¨ï¸', ni: 'ğŸŒ¨ï¸' },
                57: { d: 'å‡é›¨', n: 'å‡é›¨', di: 'ğŸŒ¨ï¸', ni: 'ğŸŒ¨ï¸' },
                61: { d: 'é™é›¨', n: 'é™é›¨', di: 'ğŸŒ§ï¸', ni: 'ğŸŒ§ï¸' },
                63: { d: 'é™é›¨', n: 'é™é›¨', di: 'ğŸŒ§ï¸', ni: 'ğŸŒ§ï¸' },
                65: { d: 'å¤§é›¨', n: 'å¤§é›¨', di: 'ğŸŒ§ï¸', ni: 'ğŸŒ§ï¸' },
                66: { d: 'å‡é›¨', n: 'å‡é›¨', di: 'ğŸŒ¨ï¸', ni: 'ğŸŒ¨ï¸' },
                67: { d: 'å‡é›¨', n: 'å‡é›¨', di: 'ğŸŒ¨ï¸', ni: 'ğŸŒ¨ï¸' },
                71: { d: 'é™é›ª', n: 'é™é›ª', di: 'â„ï¸', ni: 'â„ï¸' },
                73: { d: 'é™é›ª', n: 'é™é›ª', di: 'â„ï¸', ni: 'â„ï¸' },
                75: { d: 'å¤§é›ª', n: 'å¤§é›ª', di: 'â„ï¸', ni: 'â„ï¸' },
                77: { d: 'é›ªç²’', n: 'é›ªç²’', di: 'â„ï¸', ni: 'â„ï¸' },
                80: { d: 'é™£é›¨', n: 'é™£é›¨', di: 'ğŸŒ¦ï¸', ni: 'ğŸŒ§ï¸' },
                81: { d: 'é™£é›¨', n: 'é™£é›¨', di: 'ğŸŒ¦ï¸', ni: 'ğŸŒ§ï¸' },
                82: { d: 'é™£é›¨', n: 'é™£é›¨', di: 'ğŸŒ¦ï¸', ni: 'ğŸŒ§ï¸' },
                85: { d: 'é™£é›ª', n: 'é™£é›ª', di: 'â„ï¸', ni: 'â„ï¸' },
                86: { d: 'é™£é›ª', n: 'é™£é›ª', di: 'â„ï¸', ni: 'â„ï¸' },
                95: { d: 'é›·é›¨', n: 'é›·é›¨', di: 'â›ˆï¸', ni: 'â›ˆï¸' },
                96: { d: 'é›·é›¨', n: 'é›·é›¨', di: 'â›ˆï¸', ni: 'â›ˆï¸' },
                99: { d: 'é›·é›¨', n: 'é›·é›¨', di: 'â›ˆï¸', ni: 'â›ˆï¸' }
            };
            const info = map[code] || { d: 'æœªçŸ¥', n: 'æœªçŸ¥', di: 'â“', ni: 'â“' };
            return { desc: isDay ? info.d : info.n, icon: isDay ? info.di : info.ni };
        }

        function getAQIColor(val) {
            if (val == '--') return 'bg-gray-500';
            if (val <= 50) return 'bg-green-500';
            if (val <= 100) return 'bg-yellow-500 text-black';
            if (val <= 150) return 'bg-orange-500';
            return 'bg-red-600';
        }

        function getAQIDesc(val) {
            if (val == '--') return 'æœªçŸ¥';
            if (val <= 50) return 'è‰¯å¥½';
            if (val <= 100) return 'æ™®é€š';
            if (val <= 150) return 'ä¸å¥åº·';
            return 'å±éšª';
        }

        function getUVDesc(val) {
            if (val <= 2) return 'ä½é‡';
            if (val <= 5) return 'ä¸­é‡';
            if (val <= 7) return 'é«˜é‡';
            if (val <= 10) return 'éé‡';
            return 'å±éšª';
        }

        function updateBackground(code, isDay) {
            const body = document.getElementById('body-bg');
            if (!isDay) { body.style.background = '#0f172a'; return; }
            if (code <= 1) body.style.background = '#2563eb';
            else if (code <= 3) body.style.background = '#475569';
            else if (code >= 95) body.style.background = '#1e293b';
            else if (code >= 50) body.style.background = '#334155';
            else body.style.background = '#3b82f6';
        }

        async function performSearch() {
            const query = document.getElementById('search-input').value;
            if(!query) return;
            const resDiv = document.getElementById('search-results');
            resDiv.innerHTML = '<div class="text-white/50 text-center mt-10">æœå°‹ä¸­...</div>';
            
            try {
                const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=zh&format=json`;
                const r = await fetch(url);
                const d = await r.json();
                
                resDiv.innerHTML = '';
                
                if(!d.results) {
                    resDiv.innerHTML = '<div class="text-white/50 text-center mt-10">æ‰¾ä¸åˆ°åœ°é»</div>';
                } else {
                    d.results.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-4 bg-white/10 rounded-xl mb-3 flex justify-between items-center cursor-pointer hover:bg-white/20 transition';
                        div.innerHTML = `
                            <div>
                                <div class="font-bold text-lg">${p.name}</div>
                                <div class="text-xs opacity-50">${p.admin1||''}, ${p.country||''}</div>
                            </div>
                            <span class="text-blue-400 text-sm">é¸æ“‡</span>
                        `;
                        div.onclick = () => {
                            changeLocation(p.latitude, p.longitude, p.name, false);
                            closeSearchModal();
                        };
                        resDiv.appendChild(div);
                    });
                }
            } catch(e) {
                resDiv.innerHTML = '<div class="text-white/50 text-center mt-10">æœå°‹å¤±æ•—</div>';
            }
        }

        function toggleFavorites() {
            const idx = appState.saved.findIndex(s => s.name === appState.name);
            if(idx >= 0) {
                appState.saved.splice(idx, 1);
            } else {
                appState.saved.push({name: appState.name, lat: appState.lat, lon: appState.lon});
            }
            localStorage.setItem('zenweather_saved', JSON.stringify(appState.saved));
            updateFavIcon();
            renderQuickBarList();
        }

        function updateFavIcon() {
            const isSaved = appState.saved.some(s => s.name === appState.name);
            const icon = document.getElementById('fav-icon');
            if (isSaved) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" fill="currentColor"></path>';
                icon.classList.add('text-yellow-400');
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>';
                icon.classList.remove('text-yellow-400');
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }
    </script>
</body>
</html>
